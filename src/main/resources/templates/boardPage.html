<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${board.title}">보드 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 드래그 중인 카드 placeholder 스타일 */
        .sortable-ghost {
            background-color: #d1e7fd;
            border: 2px dashed #0d6efd;
        }
    </style>
</head>
<body>
<div th:replace="~{nav.html :: navbar}"></div>

<div class="my-3">
    <h5>⭐ 멤버 목록</h5>
    <div>
        <span th:each="member : ${board.members}" class="badge bg-secondary me-2" th:text="${member.username}">
            Username
        </span>
    </div>
</div>

<hr>

<div class="my-3">
    <h5>📧 멤버 초대하기</h5>
    <div id="inviteTypingIndicator"></div>
    <form th:action="@{/board/{id}/invite(id=${board.id})}" method="post" class="row row-cols-lg-auto g-3 align-items-center">
        <div class="col-12">
            <input id="inviteEmailInput" type="email" name="email" class="form-control" placeholder="초대할 멤버의 이메일" required>
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary">초대</button>
        </div>
    </form>
</div>

<hr>

<div class="container-fluid mt-3">
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert" th:text="${errorMessage}"></div>

    <h1 th:text="${board.title}">보드 제목</h1>

    <div class="row flex-nowrap overflow-auto">

        <div th:each="col : ${board.columns}" class="col-md-4">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title" th:text="${col.title}">칼럼 제목</h5>

                    <div class="card-list" th:attr="data-column-id=${col.id}">
                        <div th:each="card : ${col.cards}" class="card my-2" th:attr="data-card-id=${card.id}">
                            <div class="card-body">
                                <h6 class="card-title" th:text="${card.title}">카드 제목</h6>
                                <p class="card-text" th:text="${card.description}">카드 설명</p>

                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editCardModal"
                                        th:attr="data-card-id=${card.id},
                                                 data-card-title=${card.title},
                                                 data-card-description=${card.description}">
                                    수정
                                </button>

                                <form th:action="@{/card/{id}/delete(id=${card.id})}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('정말로 삭제하시겠습니까?');">삭제</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <form th:action="@{/column/{id}/cards(id=${col.id})}" method="post" class="mt-3">
                        <div class="mb-2">
                            <input type="text" name="title" class="form-control" placeholder="새 카드 제목" required>
                        </div>
                        <div class="mb-2">
                            <textarea name="description" class="form-control" placeholder="상세 내용" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">카드 추가</button>
                    </form>
                </div>
            </div>
        </div>
    </div> <div class="modal fade" id="editCardModal" tabindex="-1" aria-labelledby="editCardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCardModalLabel">카드 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCardForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCardTitle" class="form-label">제목</label>
                        <input type="text" class="form-control" id="editCardTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCardDescription" class="form-label">상세 내용</label>
                        <textarea class="form-control" id="editCardDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<!--sockJs-->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script th:inline="javascript">

    const boardId = [[${board.id}]];
    const currentUsername = [[${#authentication.principal.username}]];
    let stompClient = null;


    // --- 카드 수정 모달 제어 ---
    const editCardModal = document.getElementById('editCardModal');
    if (editCardModal) {
        let editingCardId = null;
        editCardModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const cardId = button.getAttribute('data-card-id');
            const cardTitle = button.getAttribute('data-card-title');
            const cardDescription = button.getAttribute('data-card-description');
            editingCardId = cardId;

            // 소켓 연결이 확인
            if (stompClient && stompClient.connected) {
                stompClient.send(`/app/board/${boardId}/editing`, {}, JSON.stringify({
                    cardId: editingCardId, username: currentUsername, isEditing: true
                }));
            }
            const modalTitleInput = editCardModal.querySelector('#editCardTitle');
            const modalDescriptionTextarea = editCardModal.querySelector('#editCardDescription');
            const modalForm = editCardModal.querySelector('#editCardForm');
            modalTitleInput.value = cardTitle;
            modalDescriptionTextarea.value = cardDescription;
            modalForm.action = '/card/' + cardId + '/update';
        });
        editCardModal.addEventListener('hidden.bs.modal', event => {
            if (stompClient && stompClient.connected && editingCardId) {
                stompClient.send(`/app/board/${boardId}/editing`, {}, JSON.stringify({
                    cardId: editingCardId, username: currentUsername, isEditing: false
                }));
                editingCardId = null;
            }
        });
    }

    // --- 카드 이동(Drag and Drop) 기능 ---
    const cardLists = document.querySelectorAll('.card-list');
    cardLists.forEach(list => {
        new Sortable(list, {
            group: 'shared', animation: 150, ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const cardId = evt.item.getAttribute('data-card-id');
                const newColumnId = evt.to.getAttribute('data-column-id');
                const newOrder = evt.newIndex;
                fetch(`/api/cards/${cardId}/move`, { // (Controller의 주소와 일치해야 합니다)
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newColumnId: newColumnId, newOrder: newOrder })
                }).then(async (response) => {
                    if (!response.ok) {
                        const errorText = await response.text();
                        alert(errorText);
                        window.location.reload();
                    }
                }).catch(error => console.error('Error:', error));
            }
        });
    });

    // --- 멤버 초대 입력 감지 기능 ---
    const inviteInput = document.getElementById('inviteEmailInput');
    const inviteTypingIndicator = document.getElementById('inviteTypingIndicator');
    if(inviteInput && inviteTypingIndicator) {
        let typingTimer;
        let isTyping = false;
        const doneTypingInterval = 1000;
        inviteInput.addEventListener('input', () => {
            clearTimeout(typingTimer);
            if (!isTyping) {
                if (stompClient && stompClient.connected) {
                    stompClient.send(`/app/board/${boardId}/invite`, {}, JSON.stringify({
                        username: currentUsername, isTyping: true
                    }));
                }
                isTyping = true;
            }
            typingTimer = setTimeout(doneTyping, doneTypingInterval);
        });
        function doneTyping() {
            if (stompClient && stompClient.connected) {
                stompClient.send(`/app/board/${boardId}/invite`, {}, JSON.stringify({
                    username: currentUsername, isTyping: false
                }));
            }
            isTyping = false;
        }
    }

    // --- 3. 실시간 동기화 (WebSocket) 기능 정의 ---
    function connect() {
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
    }
    function onConnected() {
        console.log('WebSocket이 연결되었습니다.');
        stompClient.subscribe('/topic/board/' + boardId, onMessageReceived);
    }
    function onError(error) {
        console.error('WebSocket 연결에 실패했습니다.');
    }
    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        const data = message.payload;
        switch (message.type) {
            case 'CARD_CREATED':
            case 'CARD_MOVED':
            case 'CARD_DELETED':
            case 'CARD_UPDATED':
                window.location.reload();
                break;
            case 'CARD_EDITING_STARTED':
                if (data.username !== currentUsername) {
                    const cardElement = document.querySelector(`.card[data-card-id="${data.cardId}"]`);
                    if (cardElement && !cardElement.querySelector('.editing-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.className = 'badge bg-warning text-dark editing-indicator';
                        indicator.innerText = `${data.username}님이 수정 중...`;
                        cardElement.querySelector('.card-body').appendChild(indicator);
                    }
                }
                break;
            case 'CARD_EDITING_ENDED':
                const cardElementToEnd = document.querySelector(`.card[data-card-id="${data.cardId}"]`);
                if (cardElementToEnd) {
                    const indicator = cardElementToEnd.querySelector('.editing-indicator');
                    if (indicator) indicator.remove();
                }
                break;
            case 'INVITE_STARTED':
                if (data.username !== currentUsername) {
                    inviteTypingIndicator.innerText = `${data.username}님이 초대 멤버를 입력 중...`;
                }
                break;
            case 'INVITE_ENDED':
                 inviteTypingIndicator.innerText = '';
                 break;
        }
    }

    // --- 4. 페이지가 로드되면 WebSocket 연결 시작 ---
    connect();

    /*]]>*/
</script>

<script th:if="${msg}" th:inline="javascript">
    alert([[${msg}]]);
</script>

</body>
</html>